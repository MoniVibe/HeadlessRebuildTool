name: validator-label-guard

on:
  pull_request_target:
    types: [labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  guard:
    if: ${{ contains(fromJSON('["run-buildbox","validator-running","buildbox-green","buildbox-red","blocked-infra"]'), github.event.label.name) }}
    runs-on: ubuntu-latest
    steps:
      - name: Enforce validator-only control labels
        uses: actions/github-script@v7
        env:
          VALIDATOR_ACTOR: ${{ vars.VALIDATOR_ACTOR }}
          VALIDATOR_ACTORS: ${{ vars.VALIDATOR_ACTORS }}
        with:
          script: |
            const marker = "<!-- validator-label-guard -->";
            const actor = context.actor;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request.number;
            const label = context.payload.label.name;

            const allowed = new Set(["github-actions[bot]"]);
            const one = process.env.VALIDATOR_ACTOR || "";
            if (one.trim()) allowed.add(one.trim().toLowerCase());
            const many = process.env.VALIDATOR_ACTORS || "";
            for (const entry of many.split(",")) {
              if (entry.trim()) allowed.add(entry.trim().toLowerCase());
            }

            if (allowed.has(actor.toLowerCase())) {
              return;
            }

            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: pr,
                name: label
              });
            } catch (err) {
              if (err.status !== 404) throw err;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr,
              body:
                `${marker}\n` +
                `Removed protected label \`${label}\` set by non-validator actor \`${actor}\`.\n` +
                `Allowed actors are configured by \`VALIDATOR_ACTOR\` / \`VALIDATOR_ACTORS\` repo vars.`
            });
            core.setFailed(`actor '${actor}' is not allowed to set '${label}'`);
